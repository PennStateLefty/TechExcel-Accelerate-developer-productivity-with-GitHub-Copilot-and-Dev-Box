name: Deploy to Azure

on:
    workflow_dispatch:
        inputs:
            env_name:
                description: 'Environment to run tests against'
                required: true
                type: string
jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            ENVIRONMENT: dev

        permissions:
            id-token: write
            contents: read

        steps:
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Set environment name
          run: echo "ENVIRONMENT=${{ github.event.inputs.env_name }}" >> $GITHUB_ENV
          if: ${{ github.event.inputs.env_name != '' }}

        - name: Login to Azure
          uses: azure/login@v1
          with:
              client-id: ${{ secrets.AZURE_CLIENT_ID }}
              tenant-id: ${{ secrets.AZURE_TENANT_ID }}
              subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
              allow-no-subscriptions: true

        - name: Run ARM deploy
          uses: azure/arm-deploy@v1
          with:
            scope: resourcegroup
            subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            resourceGroupName: ${{ secrets.AZURE_RG }}
            template: ./src/InfrastructureAsCode/main.bicep
            parameters: environment=${{ env.ENVIRONMENT }}