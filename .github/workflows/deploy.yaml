name: Deploy to Azure

on:
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        permissions:
            id-token: write
            contents: read

        steps:
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Login to Azure
          uses: azure/login@v1
          with:
              client-id: ${{ secrets.AZURE_CLIENT_ID }}
              tenant-id: ${{ secrets.AZURE_TENANT_ID }}
              subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
              allow-no-subscriptions: true

        - name: Run ARM deploy
          uses: azure/arm-deploy@v1
          with:
            scope: resource-group
            subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            resourceGroupName: ${{ secrets.AZURE_RG }}
            template: ./src/InfrastructureAsCode/main.bicep
            parameters: environment=dev